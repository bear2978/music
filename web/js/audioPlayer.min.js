class Player {constructor() { if (Player.instance) return Player.instance;return this.getInstance(...arguments);}getInstance() {let instance = new PlayerCreator(...arguments);Player.instance = instance;return instance;}}class Musics {constructor() {this.songs = [{id:"0",title:"周杰伦 - Mojito",singer:"周杰伦", songUrl:"./songs/周杰伦 - Mojito.mp3",imageUrl:'./images/pic.jpg',}]}getSongById(index) {return this.songs[index];}}class Progress {constructor(selector, options) {$.extend(this, options);this.$el = $(selector);this.width = this.$el.width();this.init();}init() {this.renderBackAndPointer();this.bindEvents();this.drag();this.changeDOMStyle(this.width * this.value);}
renderBackAndPointer() {this.$back = $('<div class="back">');this.$pointer = $('<div class="pointer">');this.$el.append(this.$back);this.$el.append(this.$pointer);}drag() {let ele = this.$pointer;let father = this.$el;let flag = false; ele.mousedown((e) => {flag = true;let mousePos = {x: e.offsetX};$(document).mousemove((e) => {if (flag === true) {let left = e.clientX - father.offset().left - mousePos.x;let distance = Math.max(0, Math.min(left, father.outerWidth(false) - ele.outerWidth(false)));let ratio = distance / father.outerWidth(false);let value = ratio * (this.max - this.min); this.changeDOMStyle(distance);this.handler(value); }})});$(document).mouseup(() => {flag = false;})}
bindEvents() { this.$el.click((e) => { let x = e.offsetX; let ratio = x / this.width; let value = ratio * (this.max - this.min); this.changeDOMStyle(x); this.handler(value); });} changeDOMStyle(distance) {this.$back.width(distance + 7 === 7 ? 0 : distance + 7); this.$pointer.css('left', distance + 'px');} setValue(value) { let distance = this.width * value / (this.max - this.min);this.changeDOMStyle(distance);}}class Btn {constructor(selector, handlers) {this.$el = $(selector); this.bindEvents(handlers);}bindEvents(handlers) { for (const event in handlers) {if (handlers.hasOwnProperty(event)) {this.$el.on(event, handlers[event]);}}}}class PlayerCreator {constructor() {
this.audio = document.querySelector('.music-player-audio');this.audio.volume = 0.6;this.musics = new Musics();this.songIndex = 0; this.loopMode = 0; this.songList = $('.music-list-content');this.renderDoms = { title: $('.music-info-title'),singer: $('.music-info-singer'),image: $('.music-player-image img'),blur: $('.music-player-blur')};this.banDom = {controlBtn: $('.control-volume-icon')};this.renderTime = {now: $('.nowTime'),total: $('.totalTime')};this.disc = {image: $('.music-player-image'),pointer: $('.music-player-pointer')};this.init();}init() {this.renderSongList();this.renderSongStyle();this.bindEventListener();}renderSongList() {let list = '';
this.musics.songs.forEach((song) => {list += `<li class="music-list-item">${song.title}</li>`});this.songList.html(list);}renderSongStyle() {let {title,singer,songUrl,imageUrl} = this.musics.getSongById(this.songIndex);this.audio.src = songUrl;this.renderDoms.title.html(title);this.renderDoms.singer.html(singer);this.renderDoms.image.prop('src', imageUrl);this.renderDoms.blur.css('background-image', 'url("' + imageUrl + '")');this.songList.find('.music-list-item').eq(this.songIndex).addClass('play').siblings().removeClass('play');}bindEventListener() {this.$play = new Btn('.player-control-btn-play', {click: this.handlePlayAndPause.bind(this)});
this.$prev = new Btn('.player-control-btn-prev', {click: this.changeSong.bind(this, 'prev')});this.$next = new Btn('.player-control-btn-next', {click: this.changeSong.bind(this, 'next')});this.$mode = new Btn('.player-control-btn-mode', {click: this.changePlayMode.bind(this)});this.$ban = new Btn('.control-volume-icon', {click: this.banNotes.bind(this)});this.songList.on('click', 'li', (e) => {let index = $(e.target).index();this.changeSong(index);});this.volumeProgress = new Progress('.control-volume-progress', {min: 0,max: 1,value: this.audio.volume,handler: (value) => { this.audio.volume = value;}});
this.audio.oncanplay = () => {if (this.progress) {this.progress.max = this.audio.duration;}else {this.progress = new Progress('.player-song-progress', {min: 0,max: this.audio.duration,value: this.audio.currentTime,handler: (value) => {this.audio.currentTime = value;}});}this.renderTime.total.html(this.formatTime(this.audio.duration));};this.audio.ontimeupdate = () => {this.progress.setValue(this.audio.currentTime);this.renderTime.now.html(this.formatTime(this.audio.currentTime));};this.audio.onended = () => {this.changeSong('next');}}handlePlayAndPause() {let playBtn = this.$play.$el.find('i');if (this.audio.paused) { console.log("play");this.audio.play();
playBtn.removeClass('icon-play').addClass('icon-pause');this.disc.image.addClass('play');this.disc.pointer.addClass('play');} else {console.log("pause");this.audio.pause();playBtn.addClass('icon-play').removeClass('icon-pause');this.disc.image.removeClass('play');this.disc.pointer.removeClass('play');}}changePlayMode() {this.loopMode++;if (this.loopMode > 2) this.loopMode = 0;this.renderPlayMode();}renderPlayMode() {let mode = ['loop', 'random', 'single'];let modeBtn = this.$mode.$el.find('i');modeBtn.prop('class', 'iconfont icon-' + mode[this.loopMode])}changeSongIndex(type) {if (typeof type === 'number') {this.songIndex = type;} else {if (this.loopMode === 0) {this.songIndex += type === 'next' ? 1 : -1;
if (this.songIndex > this.musics.songs.length - 1);this.songIndex = 0;if (this.songIndex < 0) this.songIndex = this.musics.songs.length - 1;} else if (this.loopMode === 1) {let length = this.musics.songs.length;let random = Math.floor(Math.random() * length);for (let i = 0; i < 1000; i++) {if (this.songIndex == random) {random = Math.floor(Math.random() * length);} else {this.songIndex = random;break;}}} else if (this.loopMode === 2) {this.songIndex = this.songIndex;}}}formatTime(time) {let totalMinute = parseInt(time / 60) < 10 ? "0" + parseInt(time / 60) : parseInt(time / 60);let totalSecond = parseInt(time % 60) < 10 ? "0" + parseInt(time % 60) : parseInt(time % 60);
if(isNaN(totalMinute)||isNaN(totalSecond)){return "00:00";}return totalMinute + ':' + totalSecond;}changeSong(type) {this.changeSongIndex(type);this.renderSongStyle();this.audio.play();let playBtn = this.$play.$el.find('i');playBtn.removeClass('icon-play').addClass('icon-pause');this.disc.image.addClass('play');this.disc.pointer.addClass('play');}banNotes() {let mutedBtn = this.$ban.$el.find("i");if (this.audio.muted == true) { this.audio.muted = false;this.volumeProgress.setValue(0.6);mutedBtn.removeClass('icon-muted').addClass('icon-volume');} else {this.audio.muted = true;this.volumeProgress.setValue(0);mutedBtn.removeClass('icon-volume').addClass('icon-muted');}}}new Player();